<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARC Task Creator - Standalone</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .main-content {
            display: flex;
            gap: 20px;
        }

        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 250px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .grid-area {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .dual-grid-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .grid-section {
            flex: 1;
        }

        .grid-section h4 {
            margin: 0 0 10px 0;
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .grid-section h4:hover {
            background: #e9ecef;
        }

        .grid-section.active h4 {
            background: #007bff;
            color: white;
        }

        .grid-section.active h4:hover {
            background: #0056b3;
        }

        .example-list {
            margin-bottom: 20px;
        }

        .example-group {
            margin-bottom: 15px;
        }

        .example-group h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .example-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .example-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
        }

        .example-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .example-btn:hover {
            background: #e9ecef;
        }

        .example-btn.active:hover {
            background: #0056b3;
        }

        .grid-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .grid-canvas {
            border: 2px solid #333;
            display: inline-block;
            background: white;
        }

        .grid-cell {
            width: 20px;
            height: 20px;
            border: 1px solid #ccc;
            display: inline-block;
            cursor: pointer;
        }

        .grid-row {
            height: 20px;
            line-height: 0;
            font-size: 0;
        }

        .color-palette {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .color-grid {
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: wrap;
        }

        .color-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-radius: 4px;
        }

        .color-btn.active {
            border-width: 4px;
            border-color: #ff0000;
        }

        button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            background: #e9ecef;
        }

        button.primary {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        button.primary:hover {
            background: #0056b3;
        }

        select, input {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .tool-group {
            display: flex;
            gap: 5px;
        }

        .tool-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            cursor: pointer;
            border-radius: 4px;
        }

        .tool-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .export-area {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .json-output {
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }

        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé® ARC Task Creator - Standalone</h1>
        <div class="controls">
            <div class="control-group">
                <label>Task Type:</label>
                <select id="taskType">
                    <option value="training">Training</option>
                    <option value="evaluation">Evaluation</option>
                </select>
            </div>
            <div class="control-group">
                <label>Train Examples:</label>
                <input type="number" id="trainCount" min="1" max="10" value="3">
            </div>
            <div class="control-group">
                <label>Test Examples:</label>
                <input type="number" id="testCount" min="1" max="5" value="1">
            </div>
            <button onclick="newTask()">üÜï New Task</button>
            <button onclick="saveTask()" class="primary">üíæ Save Task</button>
            <button onclick="showSavedTasks()">üìã View Saved</button>
        </div>
        <div id="status" class="status"></div>
    </div>

    <div class="main-content">
        <div class="sidebar">
            <div class="example-list" id="exampleList">
                <!-- Example buttons will be generated here -->
            </div>
        </div>

        <div class="grid-area">
            <div class="grid-controls">
                <div id="singleGridControls" style="display: none;">
                    <div class="control-group">
                        <label>Width:</label>
                        <input type="number" id="singleWidth" min="1" max="30" value="3" onchange="resizeSingleGrid()">
                    </div>
                    <div class="control-group">
                        <label>Height:</label>
                        <input type="number" id="singleHeight" min="1" max="30" value="3" onchange="resizeSingleGrid()">
                    </div>
                </div>

                <div id="dualGridControls">
                    <div class="control-group">
                        <label>Input Size:</label>
                        <input type="number" id="inputWidth" min="1" max="30" value="3" onchange="resizeInputGrid()" style="width: 50px;">
                        <span>√ó</span>
                        <input type="number" id="inputHeight" min="1" max="30" value="3" onchange="resizeInputGrid()" style="width: 50px;">
                    </div>
                    <div class="control-group">
                        <label>Output Size:</label>
                        <input type="number" id="outputWidth" min="1" max="30" value="3" onchange="resizeOutputGrid()" style="width: 50px;">
                        <span>√ó</span>
                        <input type="number" id="outputHeight" min="1" max="30" value="3" onchange="resizeOutputGrid()" style="width: 50px;">
                    </div>
                </div>

                <div class="control-group">
                    <label>Tool:</label>
                    <div class="tool-group">
                        <button class="tool-btn active" onclick="setTool('edit')">‚úèÔ∏è Edit</button>
                        <button class="tool-btn" onclick="setTool('fill')">ü™£ Fill</button>
                    </div>
                </div>
                <button onclick="clearGrid()">üóëÔ∏è Clear Active</button>
            </div>

            <div id="gridContainer">
                <div id="singleGridView" style="display: none;">
                    <div id="gridCanvas" class="grid-canvas">
                        <!-- Single grid for test examples -->
                    </div>
                </div>

                <div id="dualGridView" class="dual-grid-container">
                    <div class="grid-section" id="inputSection">
                        <h4 onclick="switchToInput()">üì• Input</h4>
                        <div id="inputCanvas" class="grid-canvas">
                            <!-- Input grid -->
                        </div>
                    </div>

                    <div class="grid-section" id="outputSection">
                        <h4 onclick="switchToOutput()">üì§ Output</h4>
                        <div id="outputCanvas" class="grid-canvas">
                            <!-- Output grid -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="color-palette">
        <h3>üé® Color Palette</h3>
        <div class="color-grid">
            <div class="color-btn" style="background-color: #000000; color: white;" onclick="setColor(0)" data-color="0">0</div>
            <div class="color-btn" style="background-color: #0074D9; color: black;" onclick="setColor(1)" data-color="1">1</div>
            <div class="color-btn" style="background-color: #FF4136; color: black;" onclick="setColor(2)" data-color="2">2</div>
            <div class="color-btn" style="background-color: #2ECC40; color: black;" onclick="setColor(3)" data-color="3">3</div>
            <div class="color-btn" style="background-color: #FFDC00; color: black;" onclick="setColor(4)" data-color="4">4</div>
            <div class="color-btn" style="background-color: #AAAAAA; color: black;" onclick="setColor(5)" data-color="5">5</div>
            <div class="color-btn" style="background-color: #F012BE; color: black;" onclick="setColor(6)" data-color="6">6</div>
            <div class="color-btn" style="background-color: #FF851B; color: black;" onclick="setColor(7)" data-color="7">7</div>
            <div class="color-btn" style="background-color: #7FDBFF; color: black;" onclick="setColor(8)" data-color="8">8</div>
            <div class="color-btn" style="background-color: #870C25; color: white;" onclick="setColor(9)" data-color="9">9</div>
        </div>
    </div>

    <div class="export-area">
        <h3>üì§ Export Task</h3>
        <p>Create your task using the grid editor above, then click "Export JSON" to get the task data in ARC format.</p>
        <div id="exportContainer" style="display: none;">
            <button class="copy-btn" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
            <div id="jsonOutput" class="json-output"></div>
            <p><strong>Instructions:</strong></p>
            <ol>
                <li>Copy the JSON output above</li>
                <li>Generate a unique task ID (8 characters)</li>
                <li>Add it to your manual dataset:
                    <ul>
                        <li><code>data/manual/arc-agi_training_challenges.json</code> (for training tasks)</li>
                        <li><code>data/manual/arc-agi_evaluation_challenges.json</code> (for evaluation tasks)</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <script>
        // Global state
        let currentTask = {
            train: [],
            test: []
        };

        let currentExample = { type: 'train', index: 0 };
        let currentColor = 1;
        let currentTool = 'edit';
        let activeGrid = 'input'; // 'input' or 'output'
        let inputGridData = [];
        let outputGridData = [];

        // ARC colors
        const ARC_COLORS = {
            0: "#000000", 1: "#0074D9", 2: "#FF4136", 3: "#2ECC40", 4: "#FFDC00",
            5: "#AAAAAA", 6: "#F012BE", 7: "#FF851B", 8: "#7FDBFF", 9: "#870C25"
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Try to load from auto-save first
            if (!loadFromAutoSave()) {
                updateExampleCount();
                selectExample('train', 0);
            }
            setColor(1);
        });

        function updateExampleCount() {
            const trainCount = parseInt(document.getElementById('trainCount').value);
            const testCount = parseInt(document.getElementById('testCount').value);

            // Update task structure
            while (currentTask.train.length < trainCount) {
                currentTask.train.push({
                    input: [[0, 0, 0], [0, 0, 0], [0, 0, 0]],
                    output: [[0, 0, 0], [0, 0, 0], [0, 0, 0]]
                });
            }
            while (currentTask.train.length > trainCount) {
                currentTask.train.pop();
            }

            while (currentTask.test.length < testCount) {
                currentTask.test.push({
                    input: [[0, 0, 0], [0, 0, 0], [0, 0, 0]],
                    output: [[0, 0, 0], [0, 0, 0], [0, 0, 0]]
                });
            }
            while (currentTask.test.length > testCount) {
                currentTask.test.pop();
            }

            updateExampleList();
        }

        function updateExampleList() {
            const container = document.getElementById('exampleList');
            container.innerHTML = '';

            // Training examples
            const trainGroup = document.createElement('div');
            trainGroup.className = 'example-group';
            trainGroup.innerHTML = '<h4>üìö Training Examples</h4>';

            const trainButtons = document.createElement('div');
            trainButtons.className = 'example-buttons';

            for (let i = 0; i < currentTask.train.length; i++) {
                const pairBtn = document.createElement('button');
                pairBtn.className = 'example-btn';
                pairBtn.textContent = `Train ${i + 1} Pair`;
                pairBtn.onclick = () => selectExample('train', i);
                trainButtons.appendChild(pairBtn);
            }

            trainGroup.appendChild(trainButtons);
            container.appendChild(trainGroup);

            // Test examples
            const testGroup = document.createElement('div');
            testGroup.className = 'example-group';
            testGroup.innerHTML = '<h4>üß™ Test Examples</h4>';

            const testButtons = document.createElement('div');
            testButtons.className = 'example-buttons';

            for (let i = 0; i < currentTask.test.length; i++) {
                const pairBtn = document.createElement('button');
                pairBtn.className = 'example-btn';
                pairBtn.textContent = `Test ${i + 1} Pair`;
                pairBtn.onclick = () => selectExample('test', i);
                testButtons.appendChild(pairBtn);
            }

            testGroup.appendChild(testButtons);
            container.appendChild(testGroup);
        }

        function selectExample(type, index) {
            // Save current grids
            saveCurrentGrids();

            // Update selection
            currentExample = { type, index };

            // Update button states
            document.querySelectorAll('.example-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Always show dual grid view for both train and test examples
            document.getElementById('singleGridView').style.display = 'none';
            document.getElementById('dualGridView').style.display = 'flex';
            document.getElementById('singleGridControls').style.display = 'none';
            document.getElementById('dualGridControls').style.display = 'flex';

            // Load input and output data
            const example = (type === 'train') ? currentTask.train[index] : currentTask.test[index];

            inputGridData = example.input ? JSON.parse(JSON.stringify(example.input)) : [[0, 0, 0], [0, 0, 0], [0, 0, 0]];
            outputGridData = example.output ? JSON.parse(JSON.stringify(example.output)) : [[0, 0, 0], [0, 0, 0], [0, 0, 0]];

            // Set input as active by default
            activeGrid = 'input';
            updateActiveGridSection();

            // Update controls based on grids
            document.getElementById('inputWidth').value = inputGridData[0].length;
            document.getElementById('inputHeight').value = inputGridData.length;
            document.getElementById('outputWidth').value = outputGridData[0].length;
            document.getElementById('outputHeight').value = outputGridData.length;

            drawGrids();
        }

        function saveCurrentGrids() {
            if (currentExample.type === 'train') {
                currentTask.train[currentExample.index].input = JSON.parse(JSON.stringify(inputGridData));
                currentTask.train[currentExample.index].output = JSON.parse(JSON.stringify(outputGridData));
            } else {
                currentTask.test[currentExample.index].input = JSON.parse(JSON.stringify(inputGridData));
                currentTask.test[currentExample.index].output = JSON.parse(JSON.stringify(outputGridData));
            }

            // Auto-save to localStorage
            localStorage.setItem('arcTaskCreator_currentTask', JSON.stringify(currentTask));
        }

        function updateActiveGridSection() {
            document.getElementById('inputSection').classList.toggle('active', activeGrid === 'input');
            document.getElementById('outputSection').classList.toggle('active', activeGrid === 'output');
        }

        function drawGrids() {
            // Always draw both input and output grids
            drawSingleGrid('inputCanvas', inputGridData, 'input');
            drawSingleGrid('outputCanvas', outputGridData, 'output');
        }

        function drawSingleGrid(canvasId, gridData, gridType) {
            const canvas = document.getElementById(canvasId);
            canvas.innerHTML = '';

            for (let y = 0; y < gridData.length; y++) {
                const row = document.createElement('div');
                row.className = 'grid-row';

                for (let x = 0; x < gridData[y].length; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.style.backgroundColor = ARC_COLORS[gridData[y][x]];
                    cell.onclick = () => onCellClick(x, y, gridType);
                    cell.onmouseenter = (e) => {
                        if (e.buttons === 1) onCellClick(x, y, gridType);
                    };
                    row.appendChild(cell);
                }

                canvas.appendChild(row);
            }
        }

        function onCellClick(x, y, gridType) {
            let targetGrid;
            if (gridType === 'input') {
                targetGrid = inputGridData;
                activeGrid = 'input';
            } else {
                targetGrid = outputGridData;
                activeGrid = 'output';
            }
            updateActiveGridSection();

            if (currentTool === 'edit') {
                targetGrid[y][x] = currentColor;
                drawGrids();
                saveCurrentGrids();
            } else if (currentTool === 'fill') {
                floodFill(targetGrid, x, y, targetGrid[y][x], currentColor);
                drawGrids();
                saveCurrentGrids();
            }
        }

        function floodFill(gridData, x, y, targetColor, newColor) {
            if (targetColor === newColor) return;
            if (x < 0 || x >= gridData[0].length || y < 0 || y >= gridData.length) return;
            if (gridData[y][x] !== targetColor) return;

            gridData[y][x] = newColor;

            floodFill(gridData, x + 1, y, targetColor, newColor);
            floodFill(gridData, x - 1, y, targetColor, newColor);
            floodFill(gridData, x, y + 1, targetColor, newColor);
            floodFill(gridData, x, y - 1, targetColor, newColor);
        }

        function switchToInput() {
            activeGrid = 'input';
            updateActiveGridSection();
        }

        function switchToOutput() {
            activeGrid = 'output';
            updateActiveGridSection();
        }

        function resizeInputGrid() {
            const width = parseInt(document.getElementById('inputWidth').value);
            const height = parseInt(document.getElementById('inputHeight').value);
            resizeGridData(inputGridData, width, height, 'input');
        }

        function resizeOutputGrid() {
            const width = parseInt(document.getElementById('outputWidth').value);
            const height = parseInt(document.getElementById('outputHeight').value);
            resizeGridData(outputGridData, width, height, 'output');
        }

        function resizeGridData(targetGrid, width, height, gridType) {
            const newGrid = [];
            for (let y = 0; y < height; y++) {
                const row = [];
                for (let x = 0; x < width; x++) {
                    if (y < targetGrid.length && x < targetGrid[y].length) {
                        row.push(targetGrid[y][x]);
                    } else {
                        row.push(0);
                    }
                }
                newGrid.push(row);
            }

            if (gridType === 'input') {
                inputGridData = newGrid;
            } else {
                outputGridData = newGrid;
            }

            drawGrids();
            saveCurrentGrids();
        }

        function clearGrid() {
            // Clear the active grid
            let targetGrid = (activeGrid === 'output') ? outputGridData : inputGridData;

            for (let y = 0; y < targetGrid.length; y++) {
                for (let x = 0; x < targetGrid[y].length; x++) {
                    targetGrid[y][x] = 0;
                }
            }

            drawGrids();
            saveCurrentGrids();
        }

        function setColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-color="${color}"]`).classList.add('active');
        }

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function newTask() {
            currentTask = {
                train: [],
                test: []
            };
            updateExampleCount();
            selectExample('train', 0);
            showStatus('‚úÖ New task created', 'success');
            document.getElementById('exportContainer').style.display = 'none';

            // Clear auto-save
            localStorage.removeItem('arcTaskCreator_currentTask');
        }

        function loadFromAutoSave() {
            const saved = localStorage.getItem('arcTaskCreator_currentTask');
            if (saved) {
                try {
                    currentTask = JSON.parse(saved);
                    updateExampleCount();
                    selectExample('train', 0);
                    showStatus('‚úÖ Restored previous work from auto-save', 'success');
                    return true;
                } catch (e) {
                    console.error('Failed to load auto-save:', e);
                }
            }
            return false;
        }

        function saveTask() {
            saveCurrentGrids();

            const taskType = document.getElementById('taskType').value;
            const taskId = generateTaskId();

            const output = {
                task_id: taskId,
                task_type: taskType,
                task_data: currentTask
            };

            const jsonOutput = JSON.stringify(output, null, 2);
            document.getElementById('jsonOutput').textContent = jsonOutput;
            document.getElementById('exportContainer').style.display = 'block';

            // Also save to localStorage with timestamp
            const savedTasks = JSON.parse(localStorage.getItem('arcTaskCreator_savedTasks') || '[]');
            savedTasks.push({
                id: taskId,
                type: taskType,
                data: currentTask,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('arcTaskCreator_savedTasks', JSON.stringify(savedTasks));

            showStatus(`‚úÖ Task saved with ID: ${taskId}!`, 'success');
        }

        function showSavedTasks() {
            const savedTasks = JSON.parse(localStorage.getItem('arcTaskCreator_savedTasks') || '[]');

            if (savedTasks.length === 0) {
                showStatus('üì≠ No saved tasks found. Create and save a task first!', 'error');
                return;
            }

            let taskList = 'Saved Tasks:\\n\\n';
            savedTasks.forEach((task, index) => {
                const date = new Date(task.timestamp).toLocaleString();
                taskList += `${index + 1}. ID: ${task.id} (${task.type}) - ${date}\\n`;
            });

            const choice = prompt(taskList + '\\nEnter task number to load JSON, or Cancel:');
            if (choice && !isNaN(choice)) {
                const taskIndex = parseInt(choice) - 1;
                if (taskIndex >= 0 && taskIndex < savedTasks.length) {
                    const selectedTask = savedTasks[taskIndex];
                    const output = {
                        task_id: selectedTask.id,
                        task_type: selectedTask.type,
                        task_data: selectedTask.data
                    };

                    const jsonOutput = JSON.stringify(output, null, 2);
                    document.getElementById('jsonOutput').textContent = jsonOutput;
                    document.getElementById('exportContainer').style.display = 'block';
                    showStatus(`üìã Loaded task ${selectedTask.id} for export`, 'success');
                }
            }
        }

        function generateTaskId() {
            return Math.random().toString(36).substr(2, 8);
        }

        function copyToClipboard() {
            const jsonOutput = document.getElementById('jsonOutput');

            // Create a temporary textarea to copy from
            const textarea = document.createElement('textarea');
            textarea.value = jsonOutput.textContent;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            showStatus('üìã Copied to clipboard!', 'success');
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';

            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        // Event listeners
        document.getElementById('trainCount').addEventListener('change', updateExampleCount);
        document.getElementById('testCount').addEventListener('change', updateExampleCount);
    </script>
</body>
</html>