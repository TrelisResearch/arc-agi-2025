<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARC Task Creator - Standalone</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .main-content {
            display: flex;
            gap: 20px;
        }

        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 250px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .grid-area {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .dual-grid-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .grid-section {
            flex: 1;
        }

        .grid-section h4 {
            margin: 0 0 10px 0;
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .grid-section h4:hover {
            background: #e9ecef;
        }

        .grid-section.active h4 {
            background: #007bff;
            color: white;
        }

        .grid-section.active h4:hover {
            background: #0056b3;
        }

        .example-list {
            margin-bottom: 20px;
        }

        .example-group {
            margin-bottom: 15px;
        }

        .example-group h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .example-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .example-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
        }

        .example-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .example-btn:hover {
            background: #e9ecef;
        }

        .example-btn.active:hover {
            background: #0056b3;
        }

        .grid-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .grid-canvas {
            border: 2px solid #333;
            display: inline-block;
            background: white;
        }

        .grid-cell {
            width: 20px;
            height: 20px;
            border: 1px solid #ccc;
            display: inline-block;
            cursor: pointer;
        }

        .grid-row {
            height: 20px;
            line-height: 0;
            font-size: 0;
        }

        .color-palette {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .color-grid {
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: wrap;
        }

        .color-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-radius: 4px;
        }

        .color-btn.active {
            border-width: 4px;
            border-color: #ff0000;
        }

        button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            background: #e9ecef;
        }

        button.primary {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        button.primary:hover {
            background: #0056b3;
        }

        select, input {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .tool-group {
            display: flex;
            gap: 5px;
        }

        .tool-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            cursor: pointer;
            border-radius: 4px;
        }

        .tool-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .export-area {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .json-output {
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }

        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-btn:hover {
            background: #218838;
        }

        .task-manager {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        }

        .task-manager-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .task-manager-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .close-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .close-btn:hover {
            background: #c82333;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .task-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-info {
            flex: 1;
        }

        .task-id {
            font-weight: bold;
            color: #007bff;
            font-size: 16px;
        }

        .task-meta {
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s;
        }

        .load-btn {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .load-btn:hover {
            background: #218838;
        }

        .export-btn {
            background: #17a2b8;
            color: white;
            border-color: #17a2b8;
        }

        .export-btn:hover {
            background: #138496;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .clear-all-btn {
            background: #ffc107;
            color: #212529;
            border: 1px solid #ffc107;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .clear-all-btn:hover {
            background: #e0a800;
        }

        .download-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #eee;
        }

        .download-btn {
            background: #6f42c1;
            color: white;
            border: 1px solid #6f42c1;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }

        .download-btn:hover {
            background: #5a2d91;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé® ARC Task Creator - Standalone</h1>
        <div class="controls">
            <div class="control-group">
                <label>Task Type:</label>
                <select id="taskType">
                    <option value="training">Training</option>
                    <option value="evaluation">Evaluation</option>
                </select>
            </div>
            <div class="control-group">
                <label>Train Examples:</label>
                <input type="number" id="trainCount" min="1" max="10" value="3">
            </div>
            <div class="control-group">
                <label>Test Examples:</label>
                <input type="number" id="testCount" min="1" max="5" value="1">
            </div>
            <button onclick="newTask()">üÜï New Task</button>
            <button onclick="saveTask()" class="primary">üíæ Save as New Task</button>
            <button onclick="updateCurrentTask()" class="primary" id="updateTaskBtn" style="display: none;">üîÑ Update Current Task</button>
            <button onclick="showSavedTasks()">üìã View Saved</button>
        </div>
        <div id="currentTaskIndicator" style="display: none; margin-top: 10px; padding: 8px; background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 4px; font-size: 14px;">
            üìÇ <strong>Currently loaded:</strong> <span id="currentTaskId"></span> <button onclick="clearCurrentTask()" style="margin-left: 10px; padding: 2px 6px; font-size: 12px;">‚úï Clear</button>
        </div>
        <div id="status" class="status"></div>
    </div>

    <div class="main-content">
        <div class="sidebar">
            <div class="example-list" id="exampleList">
                <!-- Example buttons will be generated here -->
            </div>
        </div>

        <div class="grid-area">
            <div class="grid-controls">
                <div id="singleGridControls" style="display: none;">
                    <div class="control-group">
                        <label>Width:</label>
                        <input type="number" id="singleWidth" min="1" max="30" value="3" onchange="resizeSingleGrid()">
                    </div>
                    <div class="control-group">
                        <label>Height:</label>
                        <input type="number" id="singleHeight" min="1" max="30" value="3" onchange="resizeSingleGrid()">
                    </div>
                </div>

                <div id="dualGridControls">
                    <div class="control-group">
                        <label>Input Size:</label>
                        <input type="number" id="inputWidth" min="1" max="30" value="3" onchange="resizeInputGrid()" style="width: 50px;">
                        <span>√ó</span>
                        <input type="number" id="inputHeight" min="1" max="30" value="3" onchange="resizeInputGrid()" style="width: 50px;">
                    </div>
                    <div class="control-group">
                        <label>Output Size:</label>
                        <input type="number" id="outputWidth" min="1" max="30" value="3" onchange="resizeOutputGrid()" style="width: 50px;">
                        <span>√ó</span>
                        <input type="number" id="outputHeight" min="1" max="30" value="3" onchange="resizeOutputGrid()" style="width: 50px;">
                    </div>
                </div>

                <div class="control-group">
                    <label>Tool:</label>
                    <div class="tool-group">
                        <button class="tool-btn active" onclick="setTool('edit')">‚úèÔ∏è Edit</button>
                        <button class="tool-btn" onclick="setTool('fill')">ü™£ Fill</button>
                    </div>
                </div>
                <button onclick="clearGrid()">üóëÔ∏è Clear Active</button>
                <button onclick="copyInputToOutput()">üìã‚û°Ô∏è Copy Input‚ÜíOutput</button>
            </div>

            <div id="gridContainer">
                <div id="singleGridView" style="display: none;">
                    <div id="gridCanvas" class="grid-canvas">
                        <!-- Single grid for test examples -->
                    </div>
                </div>

                <div id="dualGridView" class="dual-grid-container">
                    <div class="grid-section" id="inputSection">
                        <h4 onclick="switchToInput()">üì• Input</h4>
                        <div id="inputCanvas" class="grid-canvas">
                            <!-- Input grid -->
                        </div>
                    </div>

                    <div class="grid-section" id="outputSection">
                        <h4 onclick="switchToOutput()">üì§ Output</h4>
                        <div id="outputCanvas" class="grid-canvas">
                            <!-- Output grid -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="color-palette">
        <h3>üé® Color Palette</h3>
        <div class="color-grid">
            <div class="color-btn" style="background-color: #000000; color: white;" onclick="setColor(0)" data-color="0">0</div>
            <div class="color-btn" style="background-color: #0074D9; color: black;" onclick="setColor(1)" data-color="1">1</div>
            <div class="color-btn" style="background-color: #FF4136; color: black;" onclick="setColor(2)" data-color="2">2</div>
            <div class="color-btn" style="background-color: #2ECC40; color: black;" onclick="setColor(3)" data-color="3">3</div>
            <div class="color-btn" style="background-color: #FFDC00; color: black;" onclick="setColor(4)" data-color="4">4</div>
            <div class="color-btn" style="background-color: #AAAAAA; color: black;" onclick="setColor(5)" data-color="5">5</div>
            <div class="color-btn" style="background-color: #F012BE; color: black;" onclick="setColor(6)" data-color="6">6</div>
            <div class="color-btn" style="background-color: #FF851B; color: black;" onclick="setColor(7)" data-color="7">7</div>
            <div class="color-btn" style="background-color: #7FDBFF; color: black;" onclick="setColor(8)" data-color="8">8</div>
            <div class="color-btn" style="background-color: #870C25; color: white;" onclick="setColor(9)" data-color="9">9</div>
        </div>
    </div>

    <div class="export-area">
        <h3>üì§ Export Task</h3>
        <p>Create your task using the grid editor above, then click "Export JSON" to get the task data in ARC format.</p>
        <div id="exportContainer" style="display: none;">
            <button class="copy-btn" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
            <div id="jsonOutput" class="json-output"></div>
            <p><strong>Instructions:</strong></p>
            <ol>
                <li>Copy the JSON output above</li>
                <li>Generate a unique task ID (8 characters)</li>
                <li>Add it to your manual dataset:
                    <ul>
                        <li><code>data/manual/arc-agi_training_challenges.json</code> (for training tasks)</li>
                        <li><code>data/manual/arc-agi_evaluation_challenges.json</code> (for evaluation tasks)</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <!-- Task Manager Modal -->
    <div id="taskManager" class="task-manager">
        <div class="task-manager-content">
            <div class="task-manager-header">
                <h2>üìã Saved Tasks</h2>
                <div>
                    <button class="clear-all-btn" onclick="clearAllTasks()">üóëÔ∏è Clear All</button>
                    <button class="close-btn" onclick="closeTaskManager()">‚úï</button>
                </div>
            </div>
            <div id="taskList" class="task-list">
                <!-- Tasks will be populated here -->
            </div>
            <div class="download-section">
                <h3>üì• Download Dataset Files</h3>
                <p>Download properly formatted ARC dataset files for all your saved tasks:</p>
                <button class="download-btn" onclick="downloadChallengesFile('training')">üì• Training Challenges</button>
                <button class="download-btn" onclick="downloadSolutionsFile('training')">üì• Training Solutions</button>
                <button class="download-btn" onclick="downloadChallengesFile('evaluation')">üì• Evaluation Challenges</button>
                <button class="download-btn" onclick="downloadSolutionsFile('evaluation')">üì• Evaluation Solutions</button>
                <p style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 14px;">
                    <strong>üìÇ Easy Setup:</strong> After downloading, run <code>uv run experimental/move_downloads.py</code> to automatically move files from Downloads to <code>data/manual/</code>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentTask = {
            train: [],
            test: []
        };
        let currentLoadedTask = null; // Track currently loaded task for updates

        let currentExample = null; // Don't initialize until ready
        let currentColor = 1;
        let currentTool = 'edit';
        let activeGrid = 'input'; // 'input' or 'output'
        let inputGridData = [[0, 0, 0], [0, 0, 0], [0, 0, 0]]; // Initialize with valid 3x3 grid
        let outputGridData = [[0, 0, 0], [0, 0, 0], [0, 0, 0]]; // Initialize with valid 3x3 grid

        // ARC colors
        const ARC_COLORS = {
            0: "#000000", 1: "#0074D9", 2: "#FF4136", 3: "#2ECC40", 4: "#FFDC00",
            5: "#AAAAAA", 6: "#F012BE", 7: "#FF851B", 8: "#7FDBFF", 9: "#870C25"
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Try to load from auto-save first
            if (!loadFromAutoSave()) {
                updateExampleCount();
                // Add a small delay to ensure UI is ready
                setTimeout(() => {
                    selectExample('train', 0);
                }, 10);
            }
            setColor(1);
        });

        function updateExampleCount() {
            const trainCount = parseInt(document.getElementById('trainCount').value);
            const testCount = parseInt(document.getElementById('testCount').value);

            // Update task structure
            while (currentTask.train.length < trainCount) {
                currentTask.train.push({
                    input: [[0, 0, 0], [0, 0, 0], [0, 0, 0]],
                    output: [[0, 0, 0], [0, 0, 0], [0, 0, 0]]
                });
            }
            while (currentTask.train.length > trainCount) {
                currentTask.train.pop();
            }

            while (currentTask.test.length < testCount) {
                currentTask.test.push({
                    input: [[0, 0, 0], [0, 0, 0], [0, 0, 0]],
                    output: [[0, 0, 0], [0, 0, 0], [0, 0, 0]]
                });
            }
            while (currentTask.test.length > testCount) {
                currentTask.test.pop();
            }

            updateExampleList();
        }

        function updateExampleList() {
            const container = document.getElementById('exampleList');
            container.innerHTML = '';

            // Training examples
            const trainGroup = document.createElement('div');
            trainGroup.className = 'example-group';
            trainGroup.innerHTML = '<h4>üìö Training Examples</h4>';

            const trainButtons = document.createElement('div');
            trainButtons.className = 'example-buttons';

            for (let i = 0; i < currentTask.train.length; i++) {
                const pairBtn = document.createElement('button');
                pairBtn.className = 'example-btn';
                pairBtn.textContent = `Train ${i + 1} Pair`;
                pairBtn.onclick = () => selectExample('train', i);
                trainButtons.appendChild(pairBtn);
            }

            trainGroup.appendChild(trainButtons);
            container.appendChild(trainGroup);

            // Test examples
            const testGroup = document.createElement('div');
            testGroup.className = 'example-group';
            testGroup.innerHTML = '<h4>üß™ Test Examples</h4>';

            const testButtons = document.createElement('div');
            testButtons.className = 'example-buttons';

            for (let i = 0; i < currentTask.test.length; i++) {
                const pairBtn = document.createElement('button');
                pairBtn.className = 'example-btn';
                pairBtn.textContent = `Test ${i + 1} Pair`;
                pairBtn.onclick = () => selectExample('test', i);
                testButtons.appendChild(pairBtn);
            }

            testGroup.appendChild(testButtons);
            container.appendChild(testGroup);
        }

        function selectExample(type, index) {
            console.log(`Selecting ${type} example ${index}`);

            // Save current grids before switching (no auto-save)
            if (currentExample && currentExample.type && currentExample.index !== undefined) {
                saveCurrentGrids();
            }

            // Set new selection
            currentExample = { type, index };

            // Update button highlighting
            document.querySelectorAll('.example-btn').forEach(btn => btn.classList.remove('active'));
            const targetText = type === 'train' ? `Train ${index + 1} Pair` : `Test ${index + 1} Pair`;
            document.querySelectorAll('.example-btn').forEach(btn => {
                if (btn.textContent === targetText) {
                    btn.classList.add('active');
                }
            });

            // Show dual grid view
            document.getElementById('singleGridView').style.display = 'none';
            document.getElementById('dualGridView').style.display = 'flex';
            document.getElementById('singleGridControls').style.display = 'none';
            document.getElementById('dualGridControls').style.display = 'flex';

            // Get the example data - this is the key fix!
            const examples = (type === 'train') ? currentTask.train : currentTask.test;
            const example = examples[index];

            if (example && example.input && example.output) {
                console.log('Loading example data:', example);
                inputGridData = JSON.parse(JSON.stringify(example.input));
                outputGridData = JSON.parse(JSON.stringify(example.output));
            } else {
                console.warn('Example not found, using defaults');
                inputGridData = [[0, 0, 0], [0, 0, 0], [0, 0, 0]];
                outputGridData = [[0, 0, 0], [0, 0, 0], [0, 0, 0]];
            }

            // Set input as active
            activeGrid = 'input';
            updateActiveGridSection();

            // Update size controls
            document.getElementById('inputWidth').value = inputGridData[0].length;
            document.getElementById('inputHeight').value = inputGridData.length;
            document.getElementById('outputWidth').value = outputGridData[0].length;
            document.getElementById('outputHeight').value = outputGridData.length;

            // Redraw grids
            drawGrids();
        }

        function saveCurrentGrids() {
            // Guard against invalid state
            if (!currentExample || !currentExample.type || currentExample.index === undefined) {
                return;
            }

            if (currentExample.type === 'train') {
                if (!currentTask.train[currentExample.index]) {
                    currentTask.train[currentExample.index] = { input: [], output: [] };
                }
                currentTask.train[currentExample.index].input = JSON.parse(JSON.stringify(inputGridData));
                currentTask.train[currentExample.index].output = JSON.parse(JSON.stringify(outputGridData));
            } else {
                if (!currentTask.test[currentExample.index]) {
                    currentTask.test[currentExample.index] = { input: [], output: [] };
                }
                currentTask.test[currentExample.index].input = JSON.parse(JSON.stringify(inputGridData));
                currentTask.test[currentExample.index].output = JSON.parse(JSON.stringify(outputGridData));
            }

            // Removed auto-save to prevent cross-task contamination
            // Manual save only happens when user explicitly saves task
        }

        function updateActiveGridSection() {
            document.getElementById('inputSection').classList.toggle('active', activeGrid === 'input');
            document.getElementById('outputSection').classList.toggle('active', activeGrid === 'output');
        }

        function drawGrids() {
            // Always draw both input and output grids
            drawSingleGrid('inputCanvas', inputGridData, 'input');
            drawSingleGrid('outputCanvas', outputGridData, 'output');
        }

        function drawSingleGrid(canvasId, gridData, gridType) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error('Canvas not found:', canvasId);
                return;
            }

            canvas.innerHTML = '';

            // Validate grid data
            if (!gridData || !Array.isArray(gridData) || gridData.length === 0) {
                console.error('Invalid grid data:', gridData);
                return;
            }

            for (let y = 0; y < gridData.length; y++) {
                if (!Array.isArray(gridData[y])) {
                    console.error('Invalid row data at y:', y, gridData[y]);
                    continue;
                }

                const row = document.createElement('div');
                row.className = 'grid-row';

                for (let x = 0; x < gridData[y].length; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    const colorValue = gridData[y][x] || 0;
                    cell.style.backgroundColor = ARC_COLORS[colorValue];

                    // Ensure event handlers are properly bound
                    cell.onclick = function() { onCellClick(x, y, gridType); };
                    cell.onmouseenter = function(e) {
                        if (e.buttons === 1) onCellClick(x, y, gridType);
                    };

                    row.appendChild(cell);
                }

                canvas.appendChild(row);
            }
        }

        function onCellClick(x, y, gridType) {
            let targetGrid;
            if (gridType === 'input') {
                targetGrid = inputGridData;
                activeGrid = 'input';
            } else {
                targetGrid = outputGridData;
                activeGrid = 'output';
            }
            updateActiveGridSection();

            if (currentTool === 'edit') {
                // Toggle behavior: if cell is already the current color, set to black (0), otherwise set to current color
                if (targetGrid[y][x] === currentColor) {
                    targetGrid[y][x] = 0;
                } else {
                    targetGrid[y][x] = currentColor;
                }
                drawGrids();
                saveCurrentGrids();
            } else if (currentTool === 'fill') {
                floodFill(targetGrid, x, y, targetGrid[y][x], currentColor);
                drawGrids();
                saveCurrentGrids();
            }
        }

        function floodFill(gridData, x, y, targetColor, newColor) {
            if (targetColor === newColor) return;
            if (x < 0 || x >= gridData[0].length || y < 0 || y >= gridData.length) return;
            if (gridData[y][x] !== targetColor) return;

            gridData[y][x] = newColor;

            floodFill(gridData, x + 1, y, targetColor, newColor);
            floodFill(gridData, x - 1, y, targetColor, newColor);
            floodFill(gridData, x, y + 1, targetColor, newColor);
            floodFill(gridData, x, y - 1, targetColor, newColor);
        }

        function switchToInput() {
            activeGrid = 'input';
            updateActiveGridSection();
        }

        function switchToOutput() {
            activeGrid = 'output';
            updateActiveGridSection();
        }

        function resizeInputGrid() {
            const width = parseInt(document.getElementById('inputWidth').value);
            const height = parseInt(document.getElementById('inputHeight').value);
            resizeGridData(inputGridData, width, height, 'input');
        }

        function resizeOutputGrid() {
            const width = parseInt(document.getElementById('outputWidth').value);
            const height = parseInt(document.getElementById('outputHeight').value);
            resizeGridData(outputGridData, width, height, 'output');
        }

        function resizeGridData(targetGrid, width, height, gridType) {
            const newGrid = [];
            for (let y = 0; y < height; y++) {
                const row = [];
                for (let x = 0; x < width; x++) {
                    if (y < targetGrid.length && x < targetGrid[y].length) {
                        row.push(targetGrid[y][x]);
                    } else {
                        row.push(0);
                    }
                }
                newGrid.push(row);
            }

            if (gridType === 'input') {
                inputGridData = newGrid;
            } else {
                outputGridData = newGrid;
            }

            drawGrids();
            saveCurrentGrids();
        }

        function clearGrid() {
            // Clear the active grid
            let targetGrid = (activeGrid === 'output') ? outputGridData : inputGridData;

            for (let y = 0; y < targetGrid.length; y++) {
                for (let x = 0; x < targetGrid[y].length; x++) {
                    targetGrid[y][x] = 0;
                }
            }

            drawGrids();
            saveCurrentGrids();
        }

        function copyInputToOutput() {
            // Copy input grid data to output grid
            outputGridData = JSON.parse(JSON.stringify(inputGridData));

            // Update the output grid size controls to match input
            document.getElementById('outputWidth').value = inputGridData[0].length;
            document.getElementById('outputHeight').value = inputGridData.length;

            // Redraw grids and save
            drawGrids();
            saveCurrentGrids();
        }

        function setColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-color="${color}"]`).classList.add('active');
        }

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function newTask() {
            currentTask = {
                train: [],
                test: []
            };
            currentLoadedTask = null;

            // Reset grid data to ensure clean state
            inputGridData = [[0, 0, 0], [0, 0, 0], [0, 0, 0]];
            outputGridData = [[0, 0, 0], [0, 0, 0], [0, 0, 0]];
            currentExample = null;

            // Hide current task indicator and update button
            document.getElementById('currentTaskIndicator').style.display = 'none';
            document.getElementById('updateTaskBtn').style.display = 'none';

            updateExampleCount();

            // Ensure proper initialization with a delay
            setTimeout(() => {
                selectExample('train', 0);
                // Force another redraw after selection
                setTimeout(() => {
                    drawGrids();
                    showStatus('‚úÖ New task created', 'success');
                }, 10);
            }, 50);

            document.getElementById('exportContainer').style.display = 'none';

            // Clear auto-save
            localStorage.removeItem('arcTaskCreator_currentTask');
        }

        function loadFromAutoSave() {
            const saved = localStorage.getItem('arcTaskCreator_currentTask');
            if (saved) {
                try {
                    currentTask = JSON.parse(saved);
                    updateExampleCount();
                    selectExample('train', 0);
                    showStatus('‚úÖ Restored previous work from auto-save', 'success');
                    return true;
                } catch (e) {
                    console.error('Failed to load auto-save:', e);
                }
            }
            return false;
        }

        function saveTask() {
            saveCurrentGrids();

            const taskType = document.getElementById('taskType').value;
            const taskId = generateTaskId();

            // Create ARC format (for challenges file - no outputs in test)
            const arcChallenges = {};
            arcChallenges[taskId] = {
                train: currentTask.train.map(example => ({
                    input: example.input,
                    output: example.output
                })),
                test: currentTask.test.map(example => ({
                    input: example.input
                    // Note: no output for challenges file
                }))
            };

            // Create solutions format (includes test outputs) - correct ARC format
            const arcSolutions = {};
            arcSolutions[taskId] = currentTask.test.map(example => example.output);

            const challengesOutput = JSON.stringify(arcChallenges, null, 2);
            const solutionsOutput = JSON.stringify(arcSolutions, null, 2);

            // Display both formats
            const combinedOutput = `// ARC Challenges Format (for data/manual/arc-agi_${taskType}_challenges.json)
${challengesOutput}

// ARC Solutions Format (for data/manual/arc-agi_${taskType}_solutions.json)
${solutionsOutput}

// Instructions:
// 1. Copy the challenges JSON above and add it to data/manual/arc-agi_${taskType}_challenges.json
// 2. Copy the solutions JSON above and add it to data/manual/arc-agi_${taskType}_solutions.json
// 3. Make sure to add a comma after existing entries when inserting`;

            document.getElementById('jsonOutput').textContent = combinedOutput;
            document.getElementById('exportContainer').style.display = 'block';

            // Also save to localStorage with timestamp
            const savedTasks = JSON.parse(localStorage.getItem('arcTaskCreator_savedTasks') || '[]');
            savedTasks.push({
                id: taskId,
                type: taskType,
                data: currentTask,
                arcChallenges: arcChallenges,
                arcSolutions: arcSolutions,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('arcTaskCreator_savedTasks', JSON.stringify(savedTasks));

            showStatus(`‚úÖ Task saved with ID: ${taskId}!`, 'success');
        }

        function updateCurrentTask() {
            if (!currentLoadedTask) {
                showStatus('‚ùå No task loaded to update!', 'error');
                return;
            }

            saveCurrentGrids();
            const taskType = document.getElementById('taskType').value;

            // Create ARC format (for challenges file - no outputs in test)
            const arcChallenges = {};
            arcChallenges[currentLoadedTask.id] = {
                train: currentTask.train.map(example => ({
                    input: example.input,
                    output: example.output
                })),
                test: currentTask.test.map(example => ({
                    input: example.input
                    // Note: no output for challenges file
                }))
            };

            // Create solutions format (includes test outputs) - correct ARC format
            const arcSolutions = {};
            arcSolutions[currentLoadedTask.id] = currentTask.test.map(example => example.output);

            // Create updated task data with all required fields
            const updatedTask = {
                id: currentLoadedTask.id,
                type: taskType,
                data: JSON.parse(JSON.stringify(currentTask)),
                arcChallenges: arcChallenges,
                arcSolutions: arcSolutions,
                timestamp: new Date().toISOString()
            };

            // Get existing saved tasks and update the specific task
            const savedTasks = JSON.parse(localStorage.getItem('arcTaskCreator_savedTasks') || '[]');
            const taskIndex = savedTasks.findIndex(task => task.id === currentLoadedTask.id);

            if (taskIndex === -1) {
                showStatus('‚ùå Original task not found in saved tasks!', 'error');
                return;
            }

            // Update the task in place
            savedTasks[taskIndex] = updatedTask;
            localStorage.setItem('arcTaskCreator_savedTasks', JSON.stringify(savedTasks));

            // Update the loaded task info
            currentLoadedTask.type = taskType;

            // Update current task indicator
            document.getElementById('currentTaskId').textContent = `${currentLoadedTask.id} (${taskType})`;

            // Refresh task list if visible
            if (document.getElementById('taskManager').style.display === 'block') {
                populateTaskList();
            }

            showStatus(`üîÑ Updated task "${currentLoadedTask.id}"!`, 'success');
        }

        function showSavedTasks() {
            document.getElementById('taskManager').style.display = 'block';
            populateTaskList();
        }

        function closeTaskManager() {
            document.getElementById('taskManager').style.display = 'none';
        }

        function populateTaskList() {
            const savedTasks = JSON.parse(localStorage.getItem('arcTaskCreator_savedTasks') || '[]');
            const taskListContainer = document.getElementById('taskList');

            if (savedTasks.length === 0) {
                taskListContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>üì≠ No saved tasks</h3>
                        <p>Create and save a task to see it here.</p>
                    </div>
                `;
                return;
            }

            taskListContainer.innerHTML = savedTasks.map((task, index) => {
                const date = new Date(task.timestamp).toLocaleString();
                const trainCount = task.data.train ? task.data.train.length : 0;
                const testCount = task.data.test ? task.data.test.length : 0;

                return `
                    <div class="task-item">
                        <div class="task-info">
                            <div class="task-id">${task.id}</div>
                            <div class="task-meta">
                                ${task.type} ‚Ä¢ ${trainCount} train, ${testCount} test ‚Ä¢ ${date}
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="action-btn load-btn" onclick="loadTaskFromManager(${index})">
                                üìÇ Load
                            </button>
                            <button class="action-btn export-btn" onclick="exportTaskFromManager(${index})">
                                üìã Export
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteTaskFromManager(${index})">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadTaskFromManager(index) {
            const savedTasks = JSON.parse(localStorage.getItem('arcTaskCreator_savedTasks') || '[]');
            if (index >= 0 && index < savedTasks.length) {
                const selectedTask = savedTasks[index];
                loadTaskIntoEditor(selectedTask);
                closeTaskManager();
            }
        }

        function exportTaskFromManager(index) {
            const savedTasks = JSON.parse(localStorage.getItem('arcTaskCreator_savedTasks') || '[]');
            if (index >= 0 && index < savedTasks.length) {
                const selectedTask = savedTasks[index];

                // Use the new ARC format if available
                let jsonOutput;
                if (selectedTask.arcChallenges && selectedTask.arcSolutions) {
                    const combinedOutput = `// ARC Challenges Format (for data/manual/arc-agi_${selectedTask.type}_challenges.json)
${JSON.stringify(selectedTask.arcChallenges, null, 2)}

// ARC Solutions Format (for data/manual/arc-agi_${selectedTask.type}_solutions.json)
${JSON.stringify(selectedTask.arcSolutions, null, 2)}

// Instructions:
// 1. Copy the challenges JSON above and add it to data/manual/arc-agi_${selectedTask.type}_challenges.json
// 2. Copy the solutions JSON above and add it to data/manual/arc-agi_${selectedTask.type}_solutions.json
// 3. Make sure to add a comma after existing entries when inserting`;
                    jsonOutput = combinedOutput;
                } else {
                    // Fallback to old format
                    const output = {
                        task_id: selectedTask.id,
                        task_type: selectedTask.type,
                        task_data: selectedTask.data
                    };
                    jsonOutput = JSON.stringify(output, null, 2);
                }

                document.getElementById('jsonOutput').textContent = jsonOutput;
                document.getElementById('exportContainer').style.display = 'block';
                showStatus(`üìã Exported task ${selectedTask.id} JSON`, 'success');
                closeTaskManager();
            }
        }

        function deleteTaskFromManager(index) {
            const savedTasks = JSON.parse(localStorage.getItem('arcTaskCreator_savedTasks') || '[]');
            if (index >= 0 && index < savedTasks.length) {
                const taskToDelete = savedTasks[index];
                if (confirm(`Delete task "${taskToDelete.id}"? This cannot be undone!`)) {
                    savedTasks.splice(index, 1);
                    localStorage.setItem('arcTaskCreator_savedTasks', JSON.stringify(savedTasks));
                    showStatus(`üóëÔ∏è Deleted task ${taskToDelete.id}`, 'success');
                    populateTaskList(); // Refresh the list
                }
            }
        }

        function clearAllTasks() {
            if (confirm('‚ö†Ô∏è Delete ALL saved tasks? This cannot be undone!')) {
                localStorage.removeItem('arcTaskCreator_savedTasks');
                showStatus('üóëÔ∏è All tasks deleted', 'success');
                populateTaskList(); // Refresh the list
            }
        }

        function downloadChallengesFile(taskType) {
            const savedTasks = JSON.parse(localStorage.getItem('arcTaskCreator_savedTasks') || '[]');
            const filteredTasks = savedTasks.filter(task => task.type === taskType);

            if (filteredTasks.length === 0) {
                showStatus(`‚ùå No ${taskType} tasks found`, 'error');
                return;
            }

            const challenges = {};

            filteredTasks.forEach(task => {
                if (task.arcChallenges && task.arcChallenges[task.id]) {
                    challenges[task.id] = task.arcChallenges[task.id];
                } else {
                    // Fallback: convert from internal format
                    challenges[task.id] = {
                        train: task.data.train.map(ex => ({
                            input: ex.input,
                            output: ex.output
                        })),
                        test: task.data.test.map(ex => ({
                            input: ex.input
                            // No output for challenges file
                        }))
                    };
                }
            });

            // Download challenges file
            const challengesJson = JSON.stringify(challenges, null, 2);

            downloadFile(challengesJson, `arc-agi_${taskType}_challenges.json`, 'application/json');

            showStatus(`üì• Downloaded ${taskType} challenges file (${filteredTasks.length} tasks)`, 'success');
        }

        function downloadSolutionsFile(taskType) {
            const savedTasks = JSON.parse(localStorage.getItem('arcTaskCreator_savedTasks') || '[]');
            const filteredTasks = savedTasks.filter(task => task.type === taskType);

            if (filteredTasks.length === 0) {
                showStatus(`‚ùå No ${taskType} tasks found`, 'error');
                return;
            }

            const solutions = {};
            filteredTasks.forEach(task => {
                if (task.arcSolutions && task.arcSolutions[task.id]) {
                    solutions[task.id] = task.arcSolutions[task.id];
                } else {
                    // Fallback: convert from internal format - use correct ARC format (array of grids)
                    solutions[task.id] = task.data.test.map(ex => ex.output);
                }
            });

            const jsonString = JSON.stringify(solutions, null, 2);
            downloadFile(jsonString, `arc-agi_${taskType}_solutions.json`, 'application/json');
            showStatus(`üì• Downloaded ${taskType} solutions file with ${filteredTasks.length} tasks`, 'success');
        }

        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function loadTaskIntoEditor(savedTask) {
            console.log('Loading task:', savedTask.id, savedTask.data);

            // STEP 1: Completely reset all state
            currentExample = null;
            inputGridData = [[0, 0, 0], [0, 0, 0], [0, 0, 0]];
            outputGridData = [[0, 0, 0], [0, 0, 0], [0, 0, 0]];
            activeGrid = 'input';

            // STEP 2: Deep copy task data to prevent references
            currentTask = JSON.parse(JSON.stringify(savedTask.data));

            // STEP 3: Update UI controls
            document.getElementById('taskType').value = savedTask.type;
            document.getElementById('trainCount').value = currentTask.train.length;
            document.getElementById('testCount').value = currentTask.test.length;

            // STEP 4: Rebuild the example list
            updateExampleList();

            // STEP 5: Show current task indicator and Update button
            currentLoadedTask = {
                id: savedTask.id,
                type: savedTask.type
            };
            document.getElementById('currentTaskIndicator').style.display = 'block';
            document.getElementById('currentTaskId').textContent = `${savedTask.id} (${savedTask.type})`;
            document.getElementById('updateTaskBtn').style.display = 'inline-block';

            // STEP 6: Directly load first training example (no timeout)
            if (currentTask.train.length > 0) {
                selectExample('train', 0);
            }

            showStatus(`üìÇ Loaded task "${savedTask.id}" into editor`, 'success');
            document.getElementById('exportContainer').style.display = 'none';
        }

        function clearCurrentTask() {
            currentLoadedTask = null;
            document.getElementById('currentTaskIndicator').style.display = 'none';
            document.getElementById('updateTaskBtn').style.display = 'none';
            newTask();
        }

        function generateTaskId() {
            return Math.random().toString(36).substr(2, 8);
        }

        // Migration function to fix existing tasks in localStorage
        function migrateExistingTasks() {
            const savedTasks = JSON.parse(localStorage.getItem('arcTaskCreator_savedTasks') || '[]');
            let needsMigration = false;

            savedTasks.forEach(task => {
                // Check if task has old format arcSolutions
                if (task.arcSolutions && task.arcSolutions[task.id]) {
                    const solutions = task.arcSolutions[task.id];
                    // Check if it's in old format (array of objects with "output" key)
                    if (solutions.length > 0 && solutions[0] && typeof solutions[0] === 'object' && solutions[0].output) {
                        console.log(`Migrating task ${task.id} to new format`);
                        // Convert to new format (array of grids directly)
                        task.arcSolutions[task.id] = solutions.map(sol => sol.output);
                        needsMigration = true;
                    }
                }
            });

            if (needsMigration) {
                localStorage.setItem('arcTaskCreator_savedTasks', JSON.stringify(savedTasks));
                console.log('‚úÖ Migrated existing tasks to new ARC format');
                showStatus('‚úÖ Migrated existing tasks to new format', 'success');
            }
        }

        // Run migration on page load
        window.addEventListener('load', function() {
            migrateExistingTasks();
        });

        function copyToClipboard() {
            const jsonOutput = document.getElementById('jsonOutput');

            // Create a temporary textarea to copy from
            const textarea = document.createElement('textarea');
            textarea.value = jsonOutput.textContent;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            showStatus('üìã Copied to clipboard!', 'success');
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';

            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        // Event listeners
        document.getElementById('trainCount').addEventListener('change', updateExampleCount);
        document.getElementById('testCount').addEventListener('change', updateExampleCount);
    </script>
</body>
</html>