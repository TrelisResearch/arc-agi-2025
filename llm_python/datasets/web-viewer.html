<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOAR Dataset Web Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Consolas', monospace;
            background-color: #1e1e1e;
            color: #ffffff;
            padding: 20px;
        }

        .header {
            background-color: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        select, input, button {
            background-color: #3c3c3c;
            color: #ffffff;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: inherit;
        }

        button {
            background-color: #007acc;
            cursor: pointer;
        }

        button:hover {
            background-color: #005a9e;
        }

        .stats {
            background-color: #252525;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4CAF50;
        }

        .stat-label {
            font-size: 0.9em;
            color: #bbbbbb;
        }

        .main-content {
            display: flex;
            gap: 20px;
            min-height: calc(100vh - 300px);
        }

        .grids-panel {
            flex: 2;
            display: flex;
            gap: 20px;
        }

        .grid-column {
            min-width: 200px;
            flex: 1;
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            max-width: 400px;
        }

        .column-header {
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #3c3c3c;
            border-radius: 6px;
        }

        .grid-container {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #1a1a1a;
            border-radius: 6px;
        }

        .grid-label {
            font-size: 0.9em;
            margin-bottom: 8px;
            text-align: center;
            color: #cccccc;
        }

        .grid {
            display: inline-block;
            border: 1px solid #555;
            background-color: #000;
            max-width: 100%;
        }

        .grid-row {
            display: flex;
        }

        .grid-cell {
            min-width: 12px;
            min-height: 12px;
            max-width: 25px;
            max-height: 25px;
            width: calc(min(25px, max(12px, 100vw / 100)));
            height: calc(min(25px, max(12px, 100vw / 100)));
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .program-panel {
            flex: 1;
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
        }

        .program-header {
            font-weight: bold;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #3c3c3c;
            border-radius: 6px;
            text-align: center;
        }

        .program-code {
            background-color: #1a1a1a;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .nav-button {
            padding: 10px 20px;
            background-color: #007acc;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-family: inherit;
        }

        .nav-button:hover {
            background-color: #005a9e;
        }

        .nav-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
        }

        .error {
            background-color: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        /* ARC color scheme */
        .color-0 { background-color: #000000; color: #ffffff; } /* Black */
        .color-1 { background-color: #0074D9; color: #ffffff; } /* Blue */
        .color-2 { background-color: #FF4136; color: #ffffff; } /* Red */
        .color-3 { background-color: #2ECC40; color: #000000; } /* Green */
        .color-4 { background-color: #FFDC00; color: #000000; } /* Yellow */
        .color-5 { background-color: #B10DC9; color: #ffffff; } /* Purple */
        .color-6 { background-color: #FF851B; color: #000000; } /* Orange */
        .color-7 { background-color: #7FDBFF; color: #000000; } /* Light Blue */
        .color-8 { background-color: #870C25; color: #ffffff; } /* Dark Red */
        .color-9 { background-color: #F012BE; color: #ffffff; } /* Pink */

        .task-separator {
            border-top: 3px solid #555;
            margin: 30px 0;
            padding-top: 30px;
        }

        .task-info {
            background-color: #2d2d2d;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .task-id {
            font-size: 1.2em;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .correctness-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .correctness-item {
            background-color: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }

        .correct { color: #4CAF50; }
        .incorrect { color: #ff4444; }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>SOAR Dataset Web Viewer</h1>

        <div class="controls">
            <div class="control-group">
                <label>Dataset File:</label>
                <input type="file" id="fileInput" accept=".json">
            </div>

            <div class="control-group">
                <label>Task ID:</label>
                <input type="text" id="taskIdFilter" placeholder="Enter task ID">
            </div>

            <div class="control-group">
                <label>Train Filter:</label>
                <select id="trainFilter">
                    <option value="any">Any</option>
                    <option value="all-correct">All Correct</option>
                    <option value="none-correct">None Correct</option>
                    <option value="partial-correct">Partial Correct</option>
                </select>
            </div>

            <div class="control-group">
                <label>Test Filter:</label>
                <select id="testFilter">
                    <option value="any">Any</option>
                    <option value="all-correct">All Correct</option>
                    <option value="none-correct">None Correct</option>
                    <option value="partial-correct">Partial Correct</option>
                </select>
            </div>

            <div class="control-group">
                <label>Transductive:</label>
                <select id="transductiveFilter">
                    <option value="any">Any</option>
                    <option value="true">Transductive</option>
                    <option value="false">Non-transductive</option>
                </select>
            </div>

            <button id="applyFilters">Apply Filters</button>
            <button id="loadSample">Load Sample Data</button>
        </div>
    </div>

    <div id="stats" class="stats hidden">
        <!-- Stats will be populated by JavaScript -->
    </div>

    <div id="content" class="hidden">
        <div class="task-info">
            <div class="task-id" id="currentTaskId"></div>
            <div class="correctness-info">
                <div class="correctness-item">
                    <div>Train Correctness</div>
                    <div id="trainCorrectness"></div>
                </div>
                <div class="correctness-item">
                    <div>Test Correctness</div>
                    <div id="testCorrectness"></div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="grids-panel">
                <div class="grid-column">
                    <div class="column-header">Input Grids</div>
                    <div id="inputGrids"></div>
                </div>

                <div class="grid-column">
                    <div class="column-header">Ground Truth</div>
                    <div id="groundTruthGrids"></div>
                </div>

                <div class="grid-column">
                    <div class="column-header">Predicted</div>
                    <div id="predictedGrids"></div>
                </div>
            </div>

            <div class="program-panel">
                <div class="program-header">Generated Program</div>
                <div class="program-code" id="programCode"></div>
            </div>
        </div>

        <div class="navigation">
            <button class="nav-button" id="prevButton">Previous</button>
            <span id="navigationInfo">1 / 1</span>
            <button class="nav-button" id="nextButton">Next</button>
        </div>
    </div>

    <div id="loading" class="loading">
        <div>Select a JSON file or load sample data to begin...</div>
        <div style="margin-top: 15px; font-size: 0.9em; color: #aaa;">
            To convert parquet files to JSON, run:<br>
            <code style="background: #333; padding: 5px; border-radius: 3px;">
                uv run python llm_python/datasets/parquet_to_json.py input.parquet output.json
            </code>
        </div>
    </div>

    <div id="error" class="error hidden">
        <!-- Error messages will appear here -->
    </div>

    <script>
        class DatasetViewer {
            constructor() {
                this.data = [];
                this.filteredData = [];
                this.currentIndex = 0;
                this.taskData = new Map();

                this.initializeEventListeners();
            }

            initializeEventListeners() {
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileSelect(e));
                document.getElementById('applyFilters').addEventListener('click', () => this.applyFilters());
                document.getElementById('loadSample').addEventListener('click', () => this.loadSampleData());
                document.getElementById('prevButton').addEventListener('click', () => this.previousItem());
                document.getElementById('nextButton').addEventListener('click', () => this.nextItem());

                // Allow Enter key to apply filters
                ['taskIdFilter', 'trainFilter', 'testFilter', 'transductiveFilter'].forEach(id => {
                    document.getElementById(id).addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.applyFilters();
                    });
                });
            }

            async handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.name.endsWith('.json')) {
                    this.showError('Please select a JSON file. Convert parquet files using: uv run python llm_python/datasets/parquet_to_json.py input.parquet output.json');
                    return;
                }

                this.showLoading();

                try {
                    const text = await file.text();
                    const jsonData = JSON.parse(text);

                    if (!jsonData.data || !Array.isArray(jsonData.data)) {
                        throw new Error('Invalid JSON format. Expected {data: [...], task_data: {...}}');
                    }

                    this.data = jsonData.data;
                    console.log(`Loaded ${this.data.length} records`);

                    // Load task data if available
                    if (jsonData.task_data) {
                        this.taskData = new Map(Object.entries(jsonData.task_data));
                        console.log(`Loaded task data for ${this.taskData.size} tasks`);
                    }

                    this.applyFilters();

                } catch (error) {
                    this.showError('Failed to load JSON file: ' + error.message);
                }
            }

            loadSampleData() {
                // Create sample data for demonstration
                this.data = [{
                    row_id: "sample_1",
                    task_id: "007bbfb7",
                    code: `def generate(input_grid):
    # Sample program that copies input
    return input_grid`,
                    correct_train_input: [true, false, true],
                    correct_test_input: [false, true],
                    predicted_train_output: [
                        [[1, 0], [0, 1]],
                        [[2, 1], [1, 2]],
                        [[0, 3], [3, 0]]
                    ],
                    predicted_test_output: [
                        [[4, 5], [5, 4]],
                        [[6, 7], [7, 6]]
                    ],
                    model: "sample-model",
                    is_transductive: false
                }];

                // Load sample task data
                this.taskData.set("007bbfb7", {
                    train: [
                        { input: [[1, 0], [0, 1]], output: [[1, 0], [0, 1]] },
                        { input: [[2, 1], [1, 2]], output: [[2, 2], [2, 2]] },
                        { input: [[0, 3], [3, 0]], output: [[0, 3], [3, 0]] }
                    ],
                    test: [
                        { input: [[4, 5], [5, 4]], output: [[4, 4], [4, 4]] },
                        { input: [[6, 7], [7, 6]], output: null }
                    ]
                });

                console.log('Loaded sample data');
                this.applyFilters();
            }

            applyFilters() {
                const taskIdFilter = document.getElementById('taskIdFilter').value.trim();
                const trainFilter = document.getElementById('trainFilter').value;
                const testFilter = document.getElementById('testFilter').value;
                const transductiveFilter = document.getElementById('transductiveFilter').value;

                this.filteredData = this.data.filter(item => {
                    // Task ID filter
                    if (taskIdFilter && item.task_id !== taskIdFilter) {
                        return false;
                    }

                    // Train filter
                    if (trainFilter !== 'any') {
                        const correctTrain = item.correct_train_input;
                        switch (trainFilter) {
                            case 'all-correct':
                                if (!correctTrain.every(x => x)) return false;
                                break;
                            case 'none-correct':
                                if (correctTrain.some(x => x)) return false;
                                break;
                            case 'partial-correct':
                                if (!correctTrain.some(x => x) || correctTrain.every(x => x)) return false;
                                break;
                        }
                    }

                    // Test filter
                    if (testFilter !== 'any') {
                        const correctTest = item.correct_test_input;
                        switch (testFilter) {
                            case 'all-correct':
                                if (!correctTest.every(x => x)) return false;
                                break;
                            case 'none-correct':
                                if (correctTest.some(x => x)) return false;
                                break;
                            case 'partial-correct':
                                if (!correctTest.some(x => x) || correctTest.every(x => x)) return false;
                                break;
                        }
                    }

                    // Transductive filter
                    if (transductiveFilter !== 'any') {
                        const isTransductive = item.is_transductive;
                        if (transductiveFilter === 'true' && !isTransductive) return false;
                        if (transductiveFilter === 'false' && isTransductive) return false;
                    }

                    return true;
                });

                this.currentIndex = 0;
                this.updateStats();
                this.displayCurrentItem();
                this.hideLoading();
                document.getElementById('content').classList.remove('hidden');
            }

            updateStats() {
                const statsDiv = document.getElementById('stats');
                const totalItems = this.filteredData.length;

                if (totalItems === 0) {
                    statsDiv.innerHTML = '<div class="stat-item"><div class="stat-value">0</div><div class="stat-label">No items match filters</div></div>';
                    statsDiv.classList.remove('hidden');
                    return;
                }

                let totalTrainCorrect = 0;
                let totalTestCorrect = 0;
                let allTrainCorrect = 0;
                let allTestCorrect = 0;

                this.filteredData.forEach(item => {
                    const trainCorrect = item.correct_train_input.filter(x => x).length;
                    const testCorrect = item.correct_test_input.filter(x => x).length;

                    totalTrainCorrect += trainCorrect;
                    totalTestCorrect += testCorrect;

                    if (item.correct_train_input.every(x => x)) allTrainCorrect++;
                    if (item.correct_test_input.every(x => x)) allTestCorrect++;
                });

                statsDiv.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-value">${totalItems}</div>
                        <div class="stat-label">Total Items</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${allTrainCorrect}</div>
                        <div class="stat-label">All Train Correct</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${allTestCorrect}</div>
                        <div class="stat-label">All Test Correct</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${totalTrainCorrect}</div>
                        <div class="stat-label">Total Train Correct</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${totalTestCorrect}</div>
                        <div class="stat-label">Total Test Correct</div>
                    </div>
                `;

                statsDiv.classList.remove('hidden');
            }

            displayCurrentItem() {
                if (this.filteredData.length === 0) {
                    document.getElementById('content').classList.add('hidden');
                    return;
                }

                const item = this.filteredData[this.currentIndex];
                const taskData = this.taskData.get(item.task_id);

                // Update task info
                document.getElementById('currentTaskId').textContent = `Task: ${item.task_id}`;

                const trainCorrect = item.correct_train_input.filter(x => x).length;
                const testCorrect = item.correct_test_input.filter(x => x).length;

                document.getElementById('trainCorrectness').innerHTML =
                    `${trainCorrect}/${item.correct_train_input.length} <span class="${trainCorrect === item.correct_train_input.length ? 'correct' : 'incorrect'}">${trainCorrect === item.correct_train_input.length ? '✓' : '✗'}</span>`;

                document.getElementById('testCorrectness').innerHTML =
                    `${testCorrect}/${item.correct_test_input.length} <span class="${testCorrect === item.correct_test_input.length ? 'correct' : 'incorrect'}">${testCorrect === item.correct_test_input.length ? '✓' : '✗'}</span>`;

                // Display grids
                this.displayGrids(item, taskData);

                // Display program
                document.getElementById('programCode').textContent = item.code;

                // Update navigation
                document.getElementById('navigationInfo').textContent = `${this.currentIndex + 1} / ${this.filteredData.length}`;
                document.getElementById('prevButton').disabled = this.currentIndex === 0;
                document.getElementById('nextButton').disabled = this.currentIndex === this.filteredData.length - 1;
            }

            displayGrids(item, taskData) {
                const inputGridsDiv = document.getElementById('inputGrids');
                const groundTruthDiv = document.getElementById('groundTruthGrids');
                const predictedDiv = document.getElementById('predictedGrids');

                inputGridsDiv.innerHTML = '';
                groundTruthDiv.innerHTML = '';
                predictedDiv.innerHTML = '';

                // Training grids
                if (taskData) {
                    taskData.train.forEach((example, i) => {
                        const isCorrect = i < item.correct_train_input.length ? item.correct_train_input[i] : false;
                        const status = isCorrect ? '✓' : '✗';
                        const statusClass = isCorrect ? 'correct' : 'incorrect';

                        inputGridsDiv.appendChild(this.createGridContainer(`Train Input ${i + 1} <span class="${statusClass}">${status}</span>`, example.input));
                        groundTruthDiv.appendChild(this.createGridContainer(`Train Expected ${i + 1} <span class="${statusClass}">${status}</span>`, example.output));

                        const predicted = i < item.predicted_train_output.length ? item.predicted_train_output[i] : [[]];
                        predictedDiv.appendChild(this.createGridContainer(`Train Predicted ${i + 1} <span class="${statusClass}">${status}</span>`, predicted));
                    });

                    // Test grids
                    taskData.test.forEach((example, i) => {
                        const isCorrect = i < item.correct_test_input.length ? item.correct_test_input[i] : false;
                        const status = isCorrect ? '✓' : '✗';
                        const statusClass = isCorrect ? 'correct' : 'incorrect';

                        inputGridsDiv.appendChild(this.createGridContainer(`Test Input ${i + 1} <span class="${statusClass}">${status}</span>`, example.input));

                        if (example.output) {
                            groundTruthDiv.appendChild(this.createGridContainer(`Test Expected ${i + 1} <span class="${statusClass}">${status}</span>`, example.output));
                        } else {
                            groundTruthDiv.appendChild(this.createGridContainer(`Test Expected ${i + 1} (Hidden)`, [[]]));
                        }

                        const predicted = i < item.predicted_test_output.length ? item.predicted_test_output[i] : [[]];
                        predictedDiv.appendChild(this.createGridContainer(`Test Predicted ${i + 1} <span class="${statusClass}">${status}</span>`, predicted));
                    });
                } else {
                    // Fallback when task data is not available
                    item.predicted_train_output.forEach((predicted, i) => {
                        const isCorrect = i < item.correct_train_input.length ? item.correct_train_input[i] : false;
                        const status = isCorrect ? '✓' : '✗';
                        const statusClass = isCorrect ? 'correct' : 'incorrect';

                        predictedDiv.appendChild(this.createGridContainer(`Train Predicted ${i + 1} <span class="${statusClass}">${status}</span>`, predicted));
                    });

                    item.predicted_test_output.forEach((predicted, i) => {
                        const isCorrect = i < item.correct_test_input.length ? item.correct_test_input[i] : false;
                        const status = isCorrect ? '✓' : '✗';
                        const statusClass = isCorrect ? 'correct' : 'incorrect';

                        predictedDiv.appendChild(this.createGridContainer(`Test Predicted ${i + 1} <span class="${statusClass}">${status}</span>`, predicted));
                    });
                }
            }

            createGridContainer(label, grid) {
                const container = document.createElement('div');
                container.className = 'grid-container';

                const labelDiv = document.createElement('div');
                labelDiv.className = 'grid-label';
                labelDiv.innerHTML = label;
                container.appendChild(labelDiv);

                const gridDiv = this.createGrid(grid);
                container.appendChild(gridDiv);

                return container;
            }

            createGrid(grid) {
                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid';

                if (!grid || grid.length === 0 || (grid.length === 1 && grid[0].length === 0)) {
                    gridDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Empty</div>';
                    return gridDiv;
                }

                // Calculate dynamic cell size based on grid dimensions
                const maxRows = grid.length;
                const maxCols = Math.max(...grid.map(row => row.length));
                const maxDimension = Math.max(maxRows, maxCols);

                // Scale cell size based on grid size - smaller cells for larger grids
                let cellSize = 20; // default
                if (maxDimension > 30) {
                    cellSize = 8;
                } else if (maxDimension > 20) {
                    cellSize = 12;
                } else if (maxDimension > 15) {
                    cellSize = 15;
                }

                grid.forEach(row => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'grid-row';

                    row.forEach(cell => {
                        const cellDiv = document.createElement('div');
                        cellDiv.className = `grid-cell color-${cell}`;
                        cellDiv.textContent = cell;
                        cellDiv.style.width = `${cellSize}px`;
                        cellDiv.style.height = `${cellSize}px`;
                        cellDiv.style.fontSize = `${Math.max(8, cellSize - 4)}px`;
                        rowDiv.appendChild(cellDiv);
                    });

                    gridDiv.appendChild(rowDiv);
                });

                return gridDiv;
            }

            previousItem() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.displayCurrentItem();
                }
            }

            nextItem() {
                if (this.currentIndex < this.filteredData.length - 1) {
                    this.currentIndex++;
                    this.displayCurrentItem();
                }
            }

            showLoading() {
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('content').classList.add('hidden');
                document.getElementById('error').classList.add('hidden');
            }

            hideLoading() {
                document.getElementById('loading').classList.add('hidden');
            }

            showError(message) {
                document.getElementById('error').textContent = message;
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.add('hidden');
            }
        }

        // Initialize the viewer when the page loads
        window.addEventListener('DOMContentLoaded', () => {
            new DatasetViewer();
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                document.getElementById('prevButton').click();
            } else if (e.key === 'ArrowRight') {
                document.getElementById('nextButton').click();
            }
        });
    </script>
</body>
</html>